generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Campaign {
  id                    String                  @id @default(cuid())
  name                  String
  description           String
  startDate             DateTime
  endDate               DateTime
  participantLimit      Int?
  eligibilityCriteria   String?
  rewardPool            Float
  rewardToken           String                  @default("USDT")
  status                CampaignStatus          @default(DRAFT)
  createdById           String
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  User                  User                    @relation(fields: [createdById], references: [id])
  CampaignParticipation CampaignParticipation[]
  Task                  Task[]

  @@index([createdAt], map: "idx_campaign_createdAt")
  @@index([status], map: "idx_campaign_status")
  @@index([status, createdAt], map: "idx_campaign_status_createdAt")
}

model CampaignParticipation {
  id         String              @id
  userId     String
  campaignId String
  status     ParticipationStatus @default(PENDING)
  joinedAt   DateTime            @default(now())
  Campaign   Campaign            @relation(fields: [campaignId], references: [id])
  User       User                @relation(fields: [userId], references: [id])

  @@unique([userId, campaignId])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Task {
  id                 String             @id @default(uuid())
  campaignId         String
  name               String
  description        String
  instructions       String?
  category           TaskCategory
  xpReward           Int
  verificationMethod VerificationMethod @default(MANUAL)
  requirements       Json?
  status             TaskStatus         @default(draft)
  isActive           Boolean            @default(true)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  Campaign           Campaign           @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  TaskSubmission     TaskSubmission[]
  taskSubTasks       TaskSubTask[]

  @@index([campaignId])
  @@index([status])
}

model TaskSubmission {
  id                 String               @id @default(cuid())
  userId             String
  taskId             String
  subTaskId          String?              // Optional: specific subtask being submitted
  proofUrl           String?
  proofImageUrl      String?              // Store the uploaded proof image path
  screenshot         String?
  description        String?
  status             SubmissionStatus     @default(PENDING)
  submittedAt        DateTime             @default(now())
  reviewedAt         DateTime?
  reviewedBy         String?
  reviewNotes        String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  Task               Task                 @relation(fields: [taskId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  User               User                 @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  VerificationAction VerificationAction[]

  @@unique([taskId, userId, subTaskId])
  @@index([taskId])
  @@index([userId])
  @@index([status])
  @@index([subTaskId])
  @@map("task_submissions")
}

model User {
  id                    String                  @id
  clerkId               String?                 @unique
  name                  String?
  email                 String                  @unique
  password              String?
  emailVerified         DateTime?
  image                 String?
  role                  Role                    @default(AMBASSADOR)
  walletAddress         String?                 @unique
  tier                  Tier                    @default(BRONZE)
  xp                    Int                     @default(0)
  tokenBalance          Float                   @default(0)
  usdtBalance           Float                   @default(0)
  lastSignedIn          DateTime?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  Account               Account[]
  Campaign              Campaign[]
  CampaignParticipation CampaignParticipation[]
  Session               Session[]
  TaskSubmission        TaskSubmission[]
  VerificationAction    VerificationAction[]
  newSubmissions        NewTaskSubmission[]
  pinnedTasks           UserPinnedTask[]
}

model VerificationAction {
  id             String         @id
  submissionId   String
  reviewerId     String
  action         ReviewAction
  comment        String?
  reviewedAt     DateTime       @default(now())
  User           User           @relation(fields: [reviewerId], references: [id])
  TaskSubmission TaskSubmission @relation(fields: [submissionId], references: [id])
}

model NewTask {
  id                 String              @id @default(uuid()) @db.Uuid
  name               String
  description        String?
  instructions       String?
  status             TaskStatus          @default(draft)
  campaignId         String?
  xp                 Int
  rewardOverride     Boolean             @default(false)
  rewardToken        String?
  rewardAmount       Decimal?            @db.Decimal(18, 6)
  frequency          TaskFrequency       @default(one_time)
  perUserCap         Int?
  globalCap          Int?
  availableFrom      DateTime?           @db.Timestamptz(6)
  availableTo        DateTime?           @db.Timestamptz(6)
  submissionCutoff   DateTime?           @db.Timestamptz(6)
  gracePeriodHours   Int?
  evidenceMode       EvidenceMode        @default(manual)
  requiredFields     Json?
  exampleProofUrls   Json?
  approvalWorkflow   ApprovalWorkflow    @default(auto)
  uniqueContent      Boolean             @default(true)
  minAccountAgeDays  Int?
  minFollowers       Int?
  ipAnomalyCheck     Boolean             @default(false)
  deviceAnomalyCheck Boolean             @default(false)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  taskType           String              @default("GENERAL")
  submissions        NewTaskSubmission[]
  pinnedByUsers      UserPinnedTask[]
  subTasks           SubTask[]

  @@index([campaignId])
  @@map("new_tasks")
}

model NewTaskSubmission {
  id              String          @id @default(uuid()) @db.Uuid
  userId          String
  taskId          String          @db.Uuid
  status          SubmissionState @default(in_progress)
  evidence        Json?
  xpAwarded       Int?
  bonusAwarded    Decimal?        @db.Decimal(18, 6)
  rejectionReason String?
  createdAt       DateTime        @default(now())
  submittedAt     DateTime?
  processedAt     DateTime?
  task            NewTask         @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, taskId])
  @@map("new_task_submissions")
}

model UserPinnedTask {
  userId   String
  taskId   String   @db.Uuid
  pinnedAt DateTime @default(now())
  task     NewTask  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, taskId])
  @@map("user_pinned_tasks")
}

model SubTask {
  id            String   @id @default(cuid())
  title         String
  description   String?
  link          String?
  xpReward      Int      @default(0)
  order         Int      @default(0)
  isCompleted   Boolean  @default(false)
  isUploadProof Boolean  @default(false)
  taskId        String   @db.Uuid
  task          NewTask  @relation(fields: [taskId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([taskId])
  @@map("subtasks")
}

model TaskSubTask {
  id            String   @id @default(cuid())
  title         String
  description   String?
  link          String?
  xpReward      Int      @default(0)
  order         Int      @default(0)
  isCompleted   Boolean  @default(false)
  isUploadProof Boolean  @default(false)
  taskId        String
  task          Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([taskId])
  @@map("task_subtasks")
}

enum TaskStatus {
  draft
  active
  archived
}

enum TaskFrequency {
  one_time
  daily
  weekly
  monthly
  recurring
}

enum EvidenceMode {
  auto
  manual
}

enum ApprovalWorkflow {
  auto
  manual
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
  NEEDS_CLARIFICATION
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum ParticipationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ReviewAction {
  APPROVE
  REJECT
  REQUEST_CLARIFICATION
}

enum Role {
  ADMIN
  AMBASSADOR
}

enum TaskCategory {
  SOCIAL_ENGAGEMENT
  CONTENT_CREATION
  COMMUNITY_BUILDING
  REFERRAL
  CUSTOM
}

enum Tier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum VerificationMethod {
  AI_AUTO
  MANUAL
  HYBRID
}

enum SubmissionState {
  in_progress
  submitted
  approved
  rejected
}
